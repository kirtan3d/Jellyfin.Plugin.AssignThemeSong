<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>xThemeSong Preferences</title>
</head>
<body>
    <div id="xThemeSongUserPreferencesPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="verticalSection">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">xThemeSong Preferences</h2>
                    </div>
                </div>
                <hr style="border-color: #333; margin-bottom: 1em;" />

                <form id="xThemeSongUserPrefsForm">
                    <div class="verticalSection verticalSection-extrabottompadding">
                        <div class="fieldDescription" style="margin-bottom: 1.5em;">
                            Control how theme songs play for you personally
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label class="emby-checkbox-label">
                                <input id="EnableThemeSongs" name="EnableThemeSongs" type="checkbox" is="emby-checkbox" />
                                <span>Enable Theme Songs</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Turn theme songs on or off for your account
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="MaxDurationSeconds">Maximum Playback Duration (seconds)</label>
                            <input id="MaxDurationSeconds" name="MaxDurationSeconds" type="number" is="emby-input" min="0" max="300" step="5" />
                            <div class="fieldDescription">
                                Limit how long theme songs play (0 = play full theme)
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel inputLabelUnfocused" for="VolumePercent">Theme Song Volume (%)</label>
                            <input id="VolumePercent" name="VolumePercent" type="range" is="emby-input" min="0" max="100" step="5" />
                            <div class="fieldDescription">
                                <span id="volumeDisplay">100%</span>
                            </div>
                        </div>

                        <br />
                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save Preferences</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            (function() {
                // Load preferences on page show
                document.querySelector('#xThemeSongUserPreferencesPage').addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    
                    var userId = ApiClient.getCurrentUserId();
                    var url = ApiClient.getUrl('xThemeSong/preferences?userId=' + userId);
                    
                    fetch(url, {
                        headers: { 'X-Emby-Token': ApiClient.accessToken() }
                    }).then(function(response) {
                        if (response.ok) return response.json();
                        throw new Error('Failed to load preferences');
                    }).then(function(prefs) {
                        document.querySelector('#EnableThemeSongs').checked = prefs.enableThemeSongs !== false;
                        document.querySelector('#MaxDurationSeconds').value = prefs.maxDurationSeconds || 0;
                        
                        var volumePercent = Math.round((prefs.volume || 1.0) * 100);
                        document.querySelector('#VolumePercent').value = volumePercent;
                        document.querySelector('#volumeDisplay').textContent = volumePercent + '%';
                        
                        Dashboard.hideLoadingMsg();
                    }).catch(function(error) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Error loading preferences: ' + error.message);
                    });
                });

                // Volume slider update display
                document.querySelector('#VolumePercent').addEventListener('input', function() {
                    document.querySelector('#volumeDisplay').textContent = this.value + '%';
                });

                // Save preferences
                document.querySelector('#xThemeSongUserPrefsForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    var volumePercent = parseInt(document.querySelector('#VolumePercent').value) || 100;
                    var volumeFloat = volumePercent / 100.0;

                    var preferences = {
                        enableThemeSongs: document.querySelector('#EnableThemeSongs').checked,
                        maxDurationSeconds: parseInt(document.querySelector('#MaxDurationSeconds').value) || 0,
                        volume: volumeFloat
                    };

                    var userId = ApiClient.getCurrentUserId();
                    var url = ApiClient.getUrl('xThemeSong/preferences?userId=' + userId);
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Emby-Token': ApiClient.accessToken()
                        },
                        body: JSON.stringify(preferences)
                    }).then(function(response) {
                        if (response.ok) return response.json();
                        throw new Error('Failed to save preferences');
                    }).then(function(result) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Preferences saved successfully!');
                    }).catch(function(error) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Error saving preferences: ' + error.message);
                    });

                    return false;
                });
            })();
        </script>
    </div>
</body>
</html>
