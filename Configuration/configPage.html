<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>xThemeSong</title>
</head>
<body>
    <div id="xThemeSongConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <div class="verticalSection">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">xThemeSong</h2>
                    </div>
                </div>
                <hr style="border-color: #333; margin-bottom: 1em;" />

                <!-- Tabs -->
                <div style="margin-bottom: 1.5em;">
                    <button class="xthemesong-tab-btn active" data-tab="settings" style="background: none; border: none; color: #00a4dc; cursor: pointer; padding: 12px 20px; font-size: 14px; border-bottom: 2px solid #00a4dc;">Settings</button>
                    <button class="xthemesong-tab-btn" data-tab="library" style="background: none; border: none; color: #999; cursor: pointer; padding: 12px 20px; font-size: 14px; border-bottom: 2px solid transparent;">Media Library</button>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="xthemesong-tab-panel" style="display: block;">
                    <form id="xThemeSongConfigForm">
                        <div class="verticalSection verticalSection-extrabottompadding">
                            <div class="sectionTitleContainer flex align-items-center">
                                <h3 class="sectionTitle">General Settings</h3>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="OverwriteExistingFiles" name="OverwriteExistingFiles" type="checkbox" is="emby-checkbox" />
                                    <span>Overwrite Existing Files</span>
                                </label>
                                <div class="fieldDescription checkboxFieldDescription">
                                    Enable this to overwrite existing theme.mp3 files when running the scheduled task
                                </div>
                            </div>

                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="AudioBitrate">Audio Bitrate (kbps)</label>
                                <input id="AudioBitrate" name="AudioBitrate" type="number" is="emby-input" min="64" max="320" step="32" />
                                <div class="fieldDescription">
                                    Audio bitrate for downloaded theme songs (default: 192)
                                </div>
                            </div>

                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="FFmpegPath">FFmpeg Path</label>
                                <input id="FFmpegPath" name="FFmpegPath" type="text" is="emby-input" placeholder="Leave empty for auto-detect" />
                                <div class="fieldDescription">
                                    Custom path to FFmpeg executable. Leave empty to auto-detect.
                                </div>
                            </div>

                            <div class="selectContainer">
                                <label class="selectLabel" for="PermissionMode">Who can manage theme songs?</label>
                                <select id="PermissionMode" name="PermissionMode" is="emby-select">
                                    <option value="0">Administrators Only</option>
                                    <option value="1">Administrators & Library Managers</option>
                                    <option value="2">Everyone (All Authenticated Users)</option>
                                </select>
                                <div class="fieldDescription">
                                    Control who can assign, edit, or delete theme songs. Library Managers can manage themes in their assigned libraries.
                                </div>
                            </div>

                            <br />
                            <div>
                                <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                    <span>Save</span>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- User Preferences Notice -->
                    <div class="verticalSection">
                        <div style="background: #1a1a1a; padding: 16px; border-radius: 8px; border-left: 4px solid #00a4dc;">
                            <h4 style="margin: 0 0 8px 0; color: #00a4dc;">ðŸ‘¤ User Preferences</h4>
                            <p style="margin: 0; color: #999;">
                                Users can customize their theme song experience (enable/disable, volume, duration) from:<br>
                                <strong>Dashboard â†’ Plugins â†’ xThemeSong User Preferences</strong>
                            </p>
                        </div>
                    </div>

                    <!-- Backup & Migration Section -->
                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Backup & Migration</h3>
                        </div>
                        
                        <div class="fieldDescription" style="margin-bottom: 1em;">
                            Export your theme song assignments for backup or migration to another Jellyfin server
                        </div>

                        <h4 style="margin-bottom: 0.5em;">Export</h4>
                        <div style="display: flex; gap: 10px; margin-bottom: 2em;">
                            <button type="button" id="btnExportJson" class="raised button-submit emby-button" is="emby-button">
                                <span>ðŸ“¥ Export (JSON)</span>
                            </button>
                            <button type="button" id="btnExportCsv" class="raised button-submit emby-button" is="emby-button">
                                <span>ðŸ“¥ Export (CSV)</span>
                            </button>
                        </div>

                        <h4 style="margin-bottom: 0.5em;">Import</h4>
                        <div class="fieldDescription" style="margin-bottom: 0.5em;">
                            Import theme assignments from a previous export (JSON format only)
                        </div>
                        <input type="file" id="importFile" accept=".json" style="margin-bottom: 0.5em;" />
                        <button type="button" id="btnImport" class="raised button-submit emby-button" is="emby-button">
                            <span>ðŸ“¤ Import</span>
                        </button>
                        
                        <div id="importResults" style="display: none; margin-top: 1.5em; padding: 1em; background: #1a1a1a; border-radius: 8px;">
                            <!-- Import results will be displayed here -->
                        </div>
                    </div>
                </div>

                <!-- Media Library Tab -->
                <div id="libraryTab" class="xthemesong-tab-panel" style="display: none;">
                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Media Library Overview</h3>
                        </div>
                        
                        <div id="libraryStats" style="display: flex; gap: 16px; margin-bottom: 20px; flex-wrap: wrap;"></div>
                        
                        <div id="libraryContent">
                            <div style="text-align: center; padding: 40px; color: #888;">
                                <p>Loading media library...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            .xthemesong-stat-box {
                background: #252525;
                padding: 16px 24px;
                border-radius: 8px;
                text-align: center;
                min-width: 120px;
            }
            .xthemesong-stat-value {
                font-size: 1.8em;
                font-weight: bold;
                color: #00a4dc;
            }
            .xthemesong-stat-label {
                color: #888;
                font-size: 12px;
                margin-top: 4px;
            }
            .xthemesong-library-group {
                margin-bottom: 24px;
                background: #1a1a1a;
                border-radius: 8px;
                padding: 16px;
            }
            .xthemesong-library-header {
                font-size: 1.1em;
                color: #00a4dc;
                margin: 0 0 12px 0;
                padding-bottom: 8px;
                border-bottom: 1px solid #333;
            }
            .xthemesong-media-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 13px;
            }
            .xthemesong-media-table th {
                text-align: left;
                padding: 10px 8px;
                color: #888;
                font-weight: 700;
                border-bottom: 1px solid #333;
            }
            .xthemesong-media-table td {
                padding: 8px;
                border-bottom: 1px solid #252525;
                vertical-align: middle;
            }
            .xthemesong-media-table tr:last-child td {
                border-bottom: 1px solid transparent !important;
            }
            .xthemesong-badge-has {
                display: none;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 11px;
                background: #2e7d32;
                color: #fff;
            }
            .xthemesong-badge-none {
                display: inline-block;
                padding: 3px 8px;
                border-radius: 4px;
                font-size: 11px;
                background: #424242;
                color: #aaa;
            }
            .xthemesong-type-movie {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                background: #1976d2;
                color: #fff;
                margin-left: 6px;
            }
            .xthemesong-type-series {
                display: inline-block;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                background: #7b1fa2;
                color: #fff;
                margin-left: 6px;
            }
            .xthemesong-url-field {
                width: 100%;
                padding: 6px 8px;
                border: 1px solid #444;
                border-radius: 4px;
                background: #2a2a2a;
                color: #fff;
                font-size: 12px;
            }
            .xthemesong-url-field:focus {
                outline: none;
                border-color: #00a4dc;
            }
            .xthemesong-btn {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 12px;
                background: #00a4dc;
                color: #fff;
            }
            .xthemesong-btn:hover {
                background: #0090c4;
            }
            .xthemesong-btn:disabled {
                background: #555;
                cursor: not-allowed;
            }
            .xthemesong-mini-audio {
                min-width: 140px;
                width: 100%;
                height: 28px;
            }
            .xthemesong-save-row {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid #333;
                text-align: right;
            }
        </style>

        <script type="text/javascript">
            (function() {
                var pluginId = '97db7543-d64d-45e1-b2e7-62729b56371f';
                var libraryData = null;
                var pendingChanges = {};

                // Tab switching
                var tabButtons = document.querySelectorAll('.xthemesong-tab-btn');
                var tabPanels = document.querySelectorAll('.xthemesong-tab-panel');

                function activateTab(tabId) {
                    tabButtons.forEach(function(btn) {
                        var isActive = btn.getAttribute('data-tab') === tabId;
                        if (isActive) {
                            btn.classList.add('active');
                            btn.style.color = '#00a4dc';
                            btn.style.borderBottom = '2px solid #00a4dc';
                        } else {
                            btn.classList.remove('active');
                            btn.style.color = '#999';
                            btn.style.borderBottom = '2px solid transparent';
                        }
                    });

                    tabPanels.forEach(function(panel) {
                        if (panel.id === tabId + 'Tab') {
                            panel.style.display = 'block';
                        } else {
                            panel.style.display = 'none';
                        }
                    });

                    // Load library data when switching to library tab
                    if (tabId === 'library' && !libraryData) {
                        loadLibraryOverview();
                    }
                }

                tabButtons.forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        activateTab(btn.getAttribute('data-tab'));
                    });
                });

                // Settings page events
                document.querySelector('#xThemeSongConfigPage').addEventListener('pageshow', function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                        document.querySelector('#OverwriteExistingFiles').checked = config.OverwriteExistingFiles || false;
                        document.querySelector('#AudioBitrate').value = config.AudioBitrate || 192;
                        document.querySelector('#FFmpegPath').value = config.FFmpegPath || '';
                        document.querySelector('#PermissionMode').value = (config.PermissionMode !== undefined && config.PermissionMode !== null) ? config.PermissionMode : 1;
                        Dashboard.hideLoadingMsg();
                    });
                });

                document.querySelector('#xThemeSongConfigForm').addEventListener('submit', function(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(pluginId).then(function(config) {
                        config.OverwriteExistingFiles = document.querySelector('#OverwriteExistingFiles').checked;
                        config.AudioBitrate = parseInt(document.querySelector('#AudioBitrate').value) || 192;
                        config.FFmpegPath = document.querySelector('#FFmpegPath').value.trim() || null;
                        config.PermissionMode = parseInt(document.querySelector('#PermissionMode').value);

                        ApiClient.updatePluginConfiguration(pluginId, config).then(function(result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });

                    return false;
                });

                // Library functions
                function loadLibraryOverview() {
                    var contentDiv = document.getElementById('libraryContent');
                    var statsDiv = document.getElementById('libraryStats');
                    
                    contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><p>Loading media library...</p></div>';
                    statsDiv.innerHTML = '';

                    var apiUrl = ApiClient.getUrl('xThemeSong/library/overview');
                    
                    fetch(apiUrl, {
                        headers: { 'X-Emby-Token': ApiClient.accessToken() }
                    }).then(function(response) {
                        if (response.ok) return response.json();
                        throw new Error('Failed to load library');
                    }).then(function(data) {
                        libraryData = data;
                        renderLibraryOverview(data);
                    }).catch(function(error) {
                        contentDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error: ' + error.message + '</div>';
                    });
                }

                function renderLibraryOverview(data) {
                    var contentDiv = document.getElementById('libraryContent');
                    var statsDiv = document.getElementById('libraryStats');
                    
                    var totalItems = 0;
                    var withTheme = 0;
                    var withoutTheme = 0;
                    
                    data.libraries.forEach(function(lib) {
                        lib.items.forEach(function(item) {
                            totalItems++;
                            if (item.hasThemeSong) withTheme++;
                            else withoutTheme++;
                        });
                    });
                    
                    statsDiv.innerHTML = 
                        '<div class="xthemesong-stat-box">' +
                            '<div class="xthemesong-stat-value">' + totalItems + '</div>' +
                            '<div class="xthemesong-stat-label">Total Media</div>' +
                        '</div>' +
                        '<div class="xthemesong-stat-box">' +
                            '<div class="xthemesong-stat-value" style="color: #4caf50;">' + withTheme + '</div>' +
                            '<div class="xthemesong-stat-label">With Theme Songs</div>' +
                        '</div>' +
                        '<div class="xthemesong-stat-box">' +
                            '<div class="xthemesong-stat-value" style="color: #ff9800;">' + withoutTheme + '</div>' +
                            '<div class="xthemesong-stat-label">Without Theme Songs</div>' +
                        '</div>';
                    
                    var html = '';
                    
                    data.libraries.forEach(function(library) {
                        html += '<div class="xthemesong-library-group" data-library-id="' + library.libraryId + '">';
                        html += '<h4 class="xthemesong-library-header">' + escapeHtml(library.libraryName) + ' (' + library.items.length + ')</h4>';
                        html += '<table class="xthemesong-media-table">';
                        html += '<thead><tr><th width="27%">Title</th><th width="33%">Status</th><th width="30%">YouTube URL</th><th width="10%" style="text-align: right;">Action</th></tr></thead>';
                        html += '<tbody>';
                        
                        library.items.forEach(function(item) {
                            var typeClass = item.type === 'Movie' ? 'xthemesong-type-movie' : 'xthemesong-type-series';
                            var statusBadgePlayer = item.hasThemeSong 
                                ? '<audio class="xthemesong-mini-audio" controls src="' + ApiClient.getUrl('xThemeSong/' + item.itemId + '/audio') + '?api_key=' + ApiClient.accessToken() + '"></audio>'
                                : '<span class="xthemesong-badge-none">No Theme</span>';

                            html += '<tr data-item-id="' + item.itemId + '">';
                            html += '<td>' + escapeHtml(item.title) + '<span class="' + typeClass + '">' + item.type + '</span></td>';
                            html += '<td>' + statusBadgePlayer + '</td>';
                            html += '<td><input type="text" class="xthemesong-url-field" data-item-id="' + item.itemId + '" value="' + escapeHtml(item.youtubeUrl || '') + '" placeholder="https://youtube.com/watch?v=..." /></td>';
                            html += '<td style="text-align: right;"><button type="button" class="xthemesong-btn" onclick="window.xThemeSongOpenAssign(\'' + item.itemId + '\')">Assign</button></td>';
                            html += '</tr>';
                        });
                        
                        html += '</tbody></table>';
                        html += '<div class="xthemesong-save-row">';
                        html += '<button type="button" class="xthemesong-btn" onclick="window.xThemeSongSaveUrls(\'' + library.libraryId + '\')">Save URLs</button>';
                        html += '</div>';
                        html += '</div>';
                    });
                    
                    if (data.libraries.length === 0) {
                        html = '<div style="text-align: center; padding: 40px; color: #888;">No media found.</div>';
                    }
                    
                    contentDiv.innerHTML = html;
                    
                    document.querySelectorAll('.xthemesong-url-field').forEach(function(input) {
                        input.addEventListener('input', function() {
                            pendingChanges[this.getAttribute('data-item-id')] = this.value;
                        });
                    });
                }

                function escapeHtml(text) {
                    if (!text) return '';
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                window.xThemeSongOpenAssign = function(itemId) {
                    if (window.xThemeSongDialog && window.xThemeSongDialog.show) {
                        window.xThemeSongDialog.show(itemId);
                    } else {
                        window.location.hash = '#/details?id=' + itemId;
                    }
                };

                window.xThemeSongSaveUrls = function(libraryId) {
                    var section = document.querySelector('[data-library-id="' + libraryId + '"]');
                    if (!section) return;
                    
                    var inputs = section.querySelectorAll('.xthemesong-url-field');
                    var saveBtn = section.querySelector('.xthemesong-save-row button');
                    var originalText = saveBtn.textContent;
                    
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                    
                    var promises = [];
                    
                    inputs.forEach(function(input) {
                        var itemId = input.getAttribute('data-item-id');
                        var url = input.value.trim();
                        
                        if (pendingChanges[itemId] !== undefined) {
                            var apiUrl = ApiClient.getUrl('xThemeSong/' + itemId + '/url');
                            promises.push(
                                fetch(apiUrl, {
                                    method: 'POST',
                                    headers: { 
                                        'X-Emby-Token': ApiClient.accessToken(),
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ youtubeUrl: url || null })
                                })
                            );
                        }
                    });
                    
                    if (promises.length === 0) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        Dashboard.alert('No changes to save');
                        return;
                    }
                    
                    Promise.all(promises).then(function(results) {
                        var allOk = results.every(function(r) { return r.ok; });
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        
                        if (allOk) {
                            Dashboard.alert('URLs saved! Run the scheduled task to download.');
                            inputs.forEach(function(input) {
                                delete pendingChanges[input.getAttribute('data-item-id')];
                            });
                        } else {
                            Dashboard.alert('Some URLs failed to save.');
                        }
                    }).catch(function(error) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = originalText;
                        Dashboard.alert('Error: ' + error.message);
                    });
                };

                // Export/Import handlers
                document.getElementById('btnExportJson').addEventListener('click', function() {
                    var url = ApiClient.getUrl('xThemeSong/export/json') + '?api_key=' + ApiClient.accessToken();
                    window.location.href = url;
                });

                document.getElementById('btnExportCsv').addEventListener('click', function() {
                    var url = ApiClient.getUrl('xThemeSong/export/csv') + '?api_key=' + ApiClient.accessToken();
                    window.location.href = url;
                });

                document.getElementById('btnImport').addEventListener('click', function() {
                    var fileInput = document.getElementById('importFile');
                    var file = fileInput.files[0];
                    
                    if (!file) {
                        Dashboard.alert('Please select a JSON file to import');
                        return;
                    }
                    
                    Dashboard.showLoadingMsg();
                    
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            var data = JSON.parse(e.target.result);
                            importThemes(data);
                        } catch (err) {
                            Dashboard.hideLoadingMsg();
                            Dashboard.alert('Error reading file: ' + err.message);
                        }
                    };
                    reader.onerror = function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Error reading file');
                    };
                    reader.readAsText(file);
                });

                function importThemes(data) {
                    var url = ApiClient.getUrl('xThemeSong/export/import');
                    
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Emby-Token': ApiClient.accessToken()
                        },
                        body: JSON.stringify(data)
                    }).then(function(response) {
                        return response.json();
                    }).then(function(result) {
                        Dashboard.hideLoadingMsg();
                        showImportResults(result);
                        document.getElementById('importFile').value = '';
                    }).catch(function(error) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Import failed: ' + error.message);
                    });
                }

                function showImportResults(result) {
                    var resultsDiv = document.getElementById('importResults');
                    
                    var html = '<h4 style="margin-top: 0; color: #00a4dc;">Import Results</h4>';
                    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 1em;">';
                    html += '<div><strong>Total:</strong> ' + result.totalThemes + '</div>';
                    html += '<div style="color: #4caf50;"><strong>Imported:</strong> ' + result.imported + '</div>';
                    html += '<div style="color: #ff9800;"><strong>Skipped:</strong> ' + result.skipped + '</div>';
                    html += '<div style="color: #f44336;"><strong>Failed:</strong> ' + result.failed + '</div>';
                    html += '</div>';
                    
                    if (result.conflicts && result.conflicts.length > 0) {
                        html += '<h5 style="color: #ff9800; margin-bottom: 0.5em;">Conflicts:</h5>';
                        html += '<ul style="margin: 0; padding-left: 1.5em; max-height: 200px; overflow-y: auto;">';
                        result.conflicts.forEach(function(conflict) {
                            html += '<li style="margin-bottom: 0.5em;">';
                            html += '<strong>' + escapeHtml(conflict.itemName) + '</strong>: ';
                            html += conflict.reason + ' - <em>' + conflict.action + '</em>';
                            html += '</li>';
                        });
                        html += '</ul>';
                    }
                    
                    if (result.errors && result.errors.length > 0) {
                        html += '<h5 style="color: #f44336; margin-top: 1em; margin-bottom: 0.5em;">Errors:</h5>';
                        html += '<ul style="margin: 0; padding-left: 1.5em; max-height: 200px; overflow-y: auto;">';
                        result.errors.forEach(function(error) {
                            html += '<li style="margin-bottom: 0.5em; color: #f44336;">' + escapeHtml(error) + '</li>';
                        });
                        html += '</ul>';
                    }
                    
                    resultsDiv.innerHTML = html;
                    resultsDiv.style.display = 'block';
                    
                    if (result.imported > 0) {
                        Dashboard.alert('Import completed! ' + result.imported + ' theme(s) imported successfully.');
                    }
                }
            })();
        </script>
    </div>
</body>
</html>
